= Spring Cloud
:toc: left
:imagesdir: images

ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]

== Reviews Service
People on the internet are keen on having opinions about everything and they love reviewing things. So as a companion to the `items-service`, there is a need for a `reviews-service` where people can rate items, and perhaps other stuff as well.

image::overview-3-reviews-service.png[]
_The reviews service_

The requirements list is kept small in this tutorial, we don't care about providing means for adding or updating reviews (via POST or PUT), the REST-API should only provide resources for getting reviews.

The reviews should be stored in a H2 in-memory database.


=== Creating the project

[quote]
____
. Go to https://start.spring.io/ (or use IntelliJ `New -> Module... -> Spring Initializr`)
. Enter the following values in fields:
.. `Group:` com.acorn.tutorial
.. `Artifact:` reviews-service
. Add dependencies (search for them and select):
.. Spring Data JPA
.. Spring Web
.. Spring Cloud Config Client
.. Lombok
.. Spring Boot Actuator
.. H2 Database
. Click `Generate the project`
. If using https://start.spring.io: open the resulting zip and copy the items-service directory to the root of the project (acorn-microservices-tutorial)
____

[TIP]
====
Let's remove some autogenerated files we don't need, delete the following files from project:

[source,bash]
rm -r */mvn* */.mvn */.gitignore */HELP.md

This will remove these files:

- reviews-service/.mvn (the whole dir)
- reviews-service/.gitignore
- reviews-service/HELP.md
- reviews-service/mvnw
- reviews-service/mvnw.cmd
====

Next edit the parent pom.xml so that it becomes aware of the child project:
[quote]
____
. Open `acorn-microservices-tutorial/pom.xml`
. Add `reviews-service` to the modules list in the parent pom:
+
[source,xml]
----
    ...

    <modules>
        <module>config-server</module>
        <module>items-service</module>
        <module>reviews-service</module>
    </modules>

    ...
----
____

Build the project to verify that all is glued together correctly, and for downloading dependencies:
[source, bash]
----
# Run mvn clean install from the acorn-microservices-tutorial directory
mvn clean install -DskipTests
----

Expected outcome after running the command:

[source]
----
[INFO] Reactor Summary for acorn-microservices-tutorial 0.0.1-SNAPSHOT:
[INFO]
[INFO] util ............................................... SUCCESS [  1.511 s]
[INFO] config-server ...................................... SUCCESS [  5.067 s]
[INFO] items-service ...................................... SUCCESS [  4.540 s]
[INFO] reviews-service .................................... SUCCESS [  6.234 s]
[INFO] acorn-microservices-tutorial ....................... SUCCESS [  0.316 s]
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
----

=== Configuring the Reviews Service application
The configuration needed for the `reviews-service` is pretty much identical with `items-service`. We need however declare it in the following ways:

* The application's general config should be defined in the central `config-server`
* A `bootstrap.yml` file must be created, holding the config for binding to the `config-server`

[quote]
____
. Create the file `config-server/src/main/resources/config/reviews-service.yml`
. Add config to file:
+
[source,yml]
----
spring:
  # Enabling h2 console, accessible at http://localhost:9090/h2-console (use JDBC URL: jdbc:h2:mem:testdb, user: sa, password: empty (leave blank))
  h2:
    console:
      enabled: true
  jpa:
    show-sql: false
    properties:
      hibernate:
        format_sql: false
        generate_statistics: false

logging:
  file: /tmp/codingsession/logs/reviews-service.log
  level:
    ROOT: INFO
    org.hibernate.stat: INFO
    org.hibernate.type: INFO
----
+
. Rebuild the `config-server`
+
[source,bash]
----
mvn clean install -DskipTests -f config-server
----
+
. Restart `config-server`
. Verify that all looks good by accessing `curl http://localhost:7777/reviews-service/default | jq`
____

Next create the reviews-service's `bootstrap.yml` and add config for binding to the central `config-server`
[quote]
____
. Delete `reviews-service/src/main/resources/application.properties`
. Create the file `reviews-service/src/main/resources/bootstrap.yml`
. Add config to file:
+
[source,yml]
----
spring:
  application:
    name: reviews-service
  cloud:
    config:
      uri: http://localhost:7777
      fail-fast: true

server:
  port: 9090
----
____

=== Adding source code
The `reviews-service` application is very similar in both it's setup and in source code compared to the `items-service`

We should add the same type of classes here as well, namely:

* A model class that will define how an Reviews object will look like. This will also take the role of an JPA-entity so it can be stored in database.
* A Spring-JPA repository class that will handle the persistence of Reviews objects.
* A Spring RestController class that will act as the REST-API to the outside, which will provide resources for retrieving _Reviews_ objects and present them on JSON-format
* A DTO (data transfer object) that represents the JSON response

==== Model class
[quote]
____
. Create a new package under `reviews-service/src/main/java/com/acorn/tutorial/reviewsservice`, name it `model`
. Add a file named `Review.java` with the below content:
+
[source,java]
----
import javax.persistence.Column;
import javax.persistence.Entity;
import javax.persistence.Id;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@NoArgsConstructor
@Entity
public class Review {

    @Id
    private Long id;

    private String type;

    @Column(name = "type_id")
    private Long typeId;

    private Integer rating;

    @Column(name = "rating_min")
    private Integer ratingMin;

    @Column(name = "rating_max")
    private Integer ratingMax;

    private String comment;
}
----
____

==== Repository class and data
Next to do is to add the repository class that will help us to store reviews in the database.
[quote]
____
. Create a new package `reviews-service/src/main/java/com/acorn/tutorial/reviewsservice/repository`
. Add a file named `ReviewRepository.java` with the below content:
+
[source,java]
----
import java.util.List;
import java.util.Optional;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;
import com.acorn.tutorial.reviewsservice.model.Review;

@Repository
public interface ReviewRepository extends JpaRepository<Review, Long> {

    Optional<List<Review>> findByType(String type);
    Optional<List<Review>> findByTypeAndTypeId(String type, Long typeId);
}
----
+
Notice that the repository class defines two methods for retrieving reviews by type (in our case the type will be 'item').
____

Some nice dummy data would be good to have. As you remember, this is achieved by adding INSERT-statements into a file named `data.sql`

[quote]
____
. Create the file `reviews-service/src/main/resources/data.sql`
. Add some reviews:
+
[source,sql]
----
insert into review(id, type, type_id, rating, rating_min, rating_max, comment) values(1, 'item', 3, 4, 1, 5, 'Cuts and slices as it should, but leaves otherwise a kind of dull expression');
insert into review(id, type, type_id, rating, rating_min, rating_max, comment) values(2, 'item', 1, 3, 1, 5, 'The spoon works until you turn it upside down, then it becomes useless');
insert into review(id, type, type_id, rating, rating_min, rating_max, comment) values(3, 'item', 2, 1, 1, 5, 'This fork would not nail a ripe cheese even if its life was dependent on it');
insert into review(id, type, type_id, rating, rating_min, rating_max, comment) values(4, 'movie', 1, 5, 1, 5, 'A frigging awesome movie');
insert into review(id, type, type_id, rating, rating_min, rating_max, comment) values(5, 'item', 1, 2, 1, 5, 'The one I got was completely flat');
----
____

Try to start the application now. You should be able to check the data via http://localhost:9090/h2-console, use JDBC URL: jdbc:h2:mem:testdb and log in using User _sa_ and no password.

[source,sql]
SELECT * FROM REVIEW

Let's continue with the classes related to the REST-API.

==== RestController class
The purpose of this class is to provide a REST-API to the surrounding microservices environment.

[quote]
____
. Create package `reviews-service/src/main/java/com/acorn/tutorial/reviewsservice/web`
. Add a file named `ReviewsServiceController.java` with the below content:
+
[source,java]
----
package com.acorn.tutorial.reviewsservice.web;

import com.acorn.tutorial.reviewsservice.model.Review;
import com.acorn.tutorial.reviewsservice.repository.ReviewRepository;
import com.acorn.tutorial.util.ServiceUtil;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;
import java.util.Collections;
import java.util.List;
import java.util.stream.Collectors;

@RestController
public class ReviewsServiceController {

    private static final Logger LOGGER = LoggerFactory.getLogger(ReviewsServiceController.class);

    private final ReviewRepository reviewRepository;

    private ServiceUtil serviceUtil;

    @Autowired
    public ReviewsServiceController(ReviewRepository reviewRepository, ServiceUtil serviceUtil) {
        this.reviewRepository = reviewRepository;
        this.serviceUtil = serviceUtil;
    }

    @GetMapping(path = "/reviews", produces = "application/json")
    public List<ReviewDto> getAllReviews() {
        return reviewRepository.findAll().stream()
                .map(this::toReviewDto)
                .collect(Collectors.toList());
    }

    @PostMapping(path = "/reviews")
    public ReviewDto addReview(@RequestBody Review newReview) {
        return toReviewDto(reviewRepository.save(newReview));
    }

    @GetMapping(path = "/reviews/{type}", produces = "application/json")
    public List<ReviewDto> getReviews(@PathVariable String type) {
        List<Review> reviews = reviewRepository.findByType(type)
                .orElseGet(Collections::emptyList);

        return reviews.stream()
                .map(this::toReviewDto)
                .collect(Collectors.toList());
    }

    @GetMapping(path = "/reviews/{type}/{typeId}", produces = "application/json")
    public List<ReviewDto> getReviewsForIndividual(@PathVariable String type, @PathVariable Long typeId) {
        List<Review> reviews = reviewRepository.findByTypeAndTypeId(type, typeId)
                .orElseGet(Collections::emptyList);

        return reviews.stream()
                .map(this::toReviewDto)
                .collect(Collectors.toList());
    }

    @DeleteMapping("/reviews/{id}")
    public void deleteReview(@PathVariable Long id) {
        reviewRepository.deleteById(id);
    }

    private ReviewDto toReviewDto(Review review) {
        final ReviewDto reviewDto = ReviewDto.of(review, serviceUtil.getServiceAddress());
        LOGGER.info("Returning {}", reviewDto);
        return reviewDto;
    }
}
----
____

The above class does not compile properly until we add the rest of the gang:

==== ServiceUtil
The `ReviewsServiceController` constructs a response containing an `ReviewDto`, into which the current service's address (hostname and port) is given via `serviceUtil.getServiceAddress()`. The `ServiceUtil.java` class is already available for use in the `util` module, so to get access to it, just add this dependency to `reviews-service/pom.xml`:

[source,xml]
----
<dependencies>
    ... (other dependencies omitted for brevity)

    <dependency>
        <groupId>com.acorn.tutorial</groupId>
        <artifactId>util</artifactId>
        <version>${project.version}</version>
    </dependency>

    ...
</dependencies>
----

The above will bring in the `ServiceUtil` class we need. This class is annotated with `@Component`, but in order to make Spring detect the class so it can be autowired, we must add the annotation `@ComponentScan("com.acorn.tutorial")` to `items-service/com/acorn/tutorial/reviewsservice/ReviewsServiceApplication.java`:

[source, java]
----
package com.acorn.tutorial.reviewsservice;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
@ComponentScan("com.acorn.tutorial")
public class ReviewsServiceApplication {

    public static void main(String[] args) {
        SpringApplication.run(ReviewsServiceApplication.class, args);
    }

}
----

==== ReviewDto
The ReviewDto is just a POJO that represents the JSON structure to send out to callers of the REST API.

[quote]
____
. Create file `reviews-service/src/main/java/com/acorn/tutorial/reviewsservice/web/ReviewDto.java`
. Add this code:
+
[source,java]
----
package com.acorn.tutorial.reviewsservice.web;

import com.acorn.tutorial.reviewsservice.model.Review;
import lombok.Data;

@Data
public class ReviewDto {

    private Long id;

    private String type;

    private Long typeId;

    private Integer rating;

    private Integer ratingMin;

    private Integer ratingMax;

    private String comment;

    private String serviceAddress;

    public static ReviewDto of(Review review, String serviceAddress) {
        return new ReviewDto(review, serviceAddress);
    }

    private ReviewDto(Review review, String serviceAddress) {
        this.id = review.getId();
        this.type = review.getType();
        this.typeId = review.getTypeId();
        this.rating = review.getRating();
        this.ratingMin = review.getRatingMin();
        this.ratingMax = review.getRatingMax();
        this.comment = review.getComment();
        this.serviceAddress = serviceAddress;
    }
}
----
____

=== Running the application
You should be able to start the fully functional service using one of these two options.

Run from IDE::
IntelliJ: There should be a Run configuration named `ReviewServiceApplication` in the Services pane. Mark it and press the green play-button to start the application. This will build and run the app.

Run from command line:: It is also possible to execute it directly from a command prompt:
+
[source, bash]
----
cd acorn-microservices-tutorial/reviews-service/target

java -jar reviews-service-0.0.1-SNAPSHOT.jar
----

Take a look at the logs, the application should start fine.

* Check the health status: `curl http://localhost:9090/actuator/health | jq`
* All reviews: `curl http://localhost:9090/reviews | jq`
* All reviews for the item type: `curl http://localhost:9090/reviews/item | jq`
* A specific review for an item type: `curl http://localhost:9090/reviews/item/2 | jq`

[NOTE]
====
This means that we have our basic services for items and reviews in place. Good work so far, it is now time to sit back and contemplate where we are going with all this.
====

<<04-service-discovery.adoc#,Nextup: Time for contemplation>>

