= Spring Cloud
:toc: left
:imagesdir: images

ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]

== Client load balancer

Netflix Ribbon is a cloud library that primarily provides client-side load balancing algorithms. This comes in handy when we start to run multiple instances of `items-service` and `reviews-service`, which we will do shortly.

image::overview-6-client-loadbalancer.png[]

The obvious benefit of running several instances of the same service, is to increase the capacity to be able to handle higher load. Ribbon helps in distributing calls to the service instances evenly.

Apart from the client-side load balancing algorithms, Ribbon also provides these features:

* _Service Discovery Integration_ – Ribbon load balancer provide service discovery in dynamic environments like a cloud. Integration with Eureka and Netflix service discovery component is included in the ribbon library

* _Fault Tolerance_ – the Ribbon API can dynamically determine whether the servers are up and running in a live environment and can detect those servers that are down

Add
[source,xml]
----
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-netflix-ribbon</artifactId>
    </dependency>
----

set `@RibbonClient(name = "items-service")`

[source,java]
----
@FeignClient(name = "items-service")
@RibbonClient(name = "items-service")
public interface ItemsClient {

    @GetMapping("/items")
    List<Item> getItems();

    @GetMapping("/items/{id}")
    Item getItem(@PathVariable Long id);
}
----

access http://localhost:8100/webapi/items

check port

access again (reload)

check port

shutdown one instance

access again

check port

=== Failure Resiliency

Turning off all instances of items service

Initially java.net.ConnectException, after timeout com.netflix.client.ClientException: Load balancer does not have available server for client: items-service

. enabling hystrix -> There was an unexpected error (type=Internal Server Error, status=500).
ItemsClient#getItem(Long) failed and no fallback available.
+
[source,yml]
----
feign:
  hystrix:
    enabled: true
----

. adding fallback code

Handle it more graceful by using feign fallback

[source,java]
----
@FeignClient(name = "items-service", fallbackFactory = ItemsClient.ItemsServiceFeignClientFallbackFactory.class)
@RibbonClient(name = "items-service")
public interface ItemsClient {

    @GetMapping("/items")
    List<Item> getItems();

    @GetMapping("/items/{id}")
    Item getItem(@PathVariable Long id);

    @Component
    class ItemsServiceFeignClientFallbackFactory implements FallbackFactory<ItemsClient> {

        @Override
        public ItemsClient create(Throwable throwable) {
            return new ItemsClient() {
                @Override
                public List<Item> getItems() {
                    return Collections.emptyList();
                }

                @Override
                public Item getItem(Long id) {
                    return null;
                }
            };
        }
    }
}
----

[source,java]
----
@FeignClient(name = "reviews-service", fallbackFactory = ReviewsClient.ReviewsServiceFallbackFactory.class)
public interface ReviewsClient {

    @GetMapping("/reviews/{type}")
    List<Review> getReviews(@PathVariable String type);

    @GetMapping("/reviews/{type}/{typeid}")
    List<Review> getReviews(@PathVariable String type, @PathVariable Long typeid);

    class ReviewsServiceFallbackFactory implements FallbackFactory<ReviewsClient> {

        @Override
        public ReviewsClient create(Throwable throwable) {
            return new ReviewsClient() {
                @Override
                public List<Review> getReviews(String type) {
                    return Collections.emptyList();
                }

                @Override
                public List<Review> getReviews(String type, Long typeid) {
                    return null;
                }
            };
        }
    }
}
----

return 200 and empty values

Turn on services again - will eventually show up again

Hystrix?


<<microservices-7.adoc#,Nextup: Gateway>>

