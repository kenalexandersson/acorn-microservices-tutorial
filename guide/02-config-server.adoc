= Spring Cloud
:toc: left
:imagesdir: images

ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]

== Spring Cloud Config server

This is how https://spring.io/projects/spring-cloud-config summarizes the config server:

_"Spring Cloud Config provides server and client-side support for externalized configuration in a distributed system. With the Config Server you have a central place to manage external properties for applications across all environments"_

Any Spring Boot application (like for instance the recently created `items-service`) that declares dependency to _Spring Boot Actuator_ and _Spring Config Client_, will automatically try to contact a config server on http://localhost:8888 for retrieving it's configuration.

The default implementation of the server storage backend uses git for managing configuration files. There are other options as well, such as database storage or local files. In this tutorial we will store the config as local files.

[TIP]
====
More on storage for the interested and wicked: https://cloud.spring.io/spring-cloud-config/reference/html/#_environment_repository

Link to complete reference: https://cloud.spring.io/spring-cloud-config/reference/html/
====

Our job here is to (A) setup a Config Server, and (B) move the configuration from `items-services` into the Config Server instead.

=== Creating the project

[quote]
____
. Go to https://start.spring.io/ (or use IntelliJ `New -> Module... -> Spring Initializr`)
. Enter the following values in fields:
.. `Group:` com.acorn.tutorial
.. `Artifact:` config-server
. Add dependencies (search for them and select):
.. Config Server
.. Spring Boot Actuator
. Click `Generate the project`
. If using https://start.spring.io: open the resulting zip and copy the items-service directory to the root of the project (acorn-microservices-tutorial)
____

[TIP]
====
If you are using IntelliJ and a dialog pops up saying "Multiple Spring Boot run configurations were detected", then click "Show run configurations in Services".

image::multiple-spring-boot.png[]

This will make it easier when starting and stopping several services at once.
====

[TIP]
====
Let's remove some autogenerated files we don't need, delete the following files from project:

- items-service/.mvn (the whole dir)
- items-service/.gitignore
- items-service/HELP.md
- items-service/mvnw
- items-service/mvnw.cmd

[source,bash]
rm -r */mvn* */.mvn */.gitignore */HELP.md
====

Next edit the parent pom.xml so that it becomes aware of the child project:
[quote]
____
. Open `acorn-microservices-tutorial/pom.xml`
. Add `config-server` to the modules list in the parent pom:
+
[source,xml]
----
    ...

    <modules>
        <module>util</module>
        <module>config-server</module>
        <module>items-service</module>
    </modules>

    ...
----
____

Build the project to verify that all is glued together correctly, and for downloading dependencies:
[source, bash]
----
# Run mvn clean install from the acorn-microservices-tutorial directory
mvn clean install -DskipTests
----

Expected outcome after running the command:

[source]
----
[INFO] Reactor Summary for acorn-microservices-tutorial 0.0.1-SNAPSHOT:
[INFO]
[INFO] util ............................................... SUCCESS [  1.511 s]
[INFO] config-server ...................................... SUCCESS [  5.067 s]
[INFO] items-service ...................................... SUCCESS [  4.540 s]
[INFO] acorn-microservices-tutorial ....................... SUCCESS [  0.316 s]
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
----

=== Configuring the Config Server

Even an application that manages configurations needs to be configured. A Spring Config Server does not require overly much configuration to be functional, at least not when you are good to go with the defaults.

In our case, we need to configure the Config Server to use the native file storage approach instead of git.

[quote]
____
. Remove the file `config-server/src/main/resource/application.properties`
. Create file `config-server/src/main/resource/bootstrap.yml` and add the below content.
+
.Content of bootstrap.yml
[source,yml]
----
spring:
  application:
    name: config-server

  # Activating the built-in profile named "native", allows us to use local files
  # as configuration storage instead
  profiles:
    active: native

  # Setting the search location to directory "config" on classpath for the "native" profile
  # (the source config files that after build ends up in dir config will go under src/main/resources/config)
  cloud:
    config:
      server:
        native:
          search-locations: classpath:/config

server:
  port: 8888
----
____

=== Running the application
This far you should be able to start the server, albeit it doesn't do anything useful yet. Run the app by using one of these two options.

Run from IDE::
IntelliJ: There should be a Run configuration named `ConfigServerApplication` in the Services pane. Mark it and press the green play-button to start the application. This will build and run the app.
+
image::config-server-in-services.png[]

Run from command line:: It is also possible to execute it directly from a command prompt:
+
[source, bash]
----
cd acorn-microservices-tutorial/config-server/target

java -jar config-server-0.0.1-SNAPSHOT.jar
----

Take a look at the logs, the application should start fine.

Check the health status: `curl http://localhost:8888/actuator/health | jq`

=== Moving configuration from items-service
We are now in the position to start using the `config-server`, letting it manage the configuration for other components in the project. So far we only have one, the `items-service` component, so it makes sense to start moving it's config into the `config-server`.

image::overview-2-config-server.png[]

[quote]
____
. Create the file `config-server/src/main/resource/config/items-service.yml`
. Cut and paste the below section from `items-services/src/main/resources/application.yml` to `config-server/src/main/resource/config/items-service.yml`:
+
[source,yml]
----
spring:
  # Enabling h2 console, accessible at http://localhost:8080/h2-console (use JDBC URL: jdbc:h2:mem:testdb, user: sa, password: empty (leave blank))
  h2:
    console:
      enabled: true
  jpa:
    show-sql: false
    properties:
      hibernate:
        format_sql: true
        generate_statistics: false

logging:
  file: /tmp/codingsession/logs/items-service.log
  level:
    ROOT: INFO
    org.hibernate.stat: INFO
    org.hibernate.type: INFO
----
+
. Make sure that the moved configuration is totally removed from `items-service/src/main/resources/application.yml`, it should now look like this:
+
[source,yml]
----
spring:
  application:
    name: items-service

server:
  port: 8080
----
____

Just moving the configuration to the `config-server` is not enough. The `items-service` component must be setup so it can bind to the `config-server` to be able to fetch the configuration. This is done by turning the `items-services` into a _Spring Cloud Config Client_, which is done by adding a maven-dependency.

[quote]
____
. Open `items-service/pom.xml`
. Add the below to the pom-file
+
[source,xml]
----
    <properties>
        <java.version>1.8</java.version>
        <!-- add this property -->
        <spring-cloud.version>Hoxton.SR1</spring-cloud.version>
    </properties>

    <dependencies>
        ...
        <!-- add this dependency -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-config-client</artifactId>
        </dependency>

        ...
    </dependencies>

    <!-- also add this section -->
    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.cloud</groupId>
                <artifactId>spring-cloud-dependencies</artifactId>
                <version>${spring-cloud.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>
----
____

If you start the `items-service` app now, the logs should show that the application tries to fetch config from http://localhost:8888, but a WARN logs says that it _"Could not locate PropertySource: label not found"_.

Two things are worth noting:

* The Spring automagic goes into play here. Bringing in the dependency `spring-cloud-config-client` to classpath will automatically activate the client behavior, which on startup will try to contact the config-server using the default url http://localhost:8888.

* In our case it finds the config-server, but not the config we added for `items-service`. Something is clearly missing in our setup.

Well, the reason for the failure is because we actually haven't enabled the `config-server` yet. Let us do that.

[quote]
____
. Enable the server by adding the annotation `@EnableConfigServer` to `ConfigServerApplication` class in the `config-server` project.
+
.Example of enabled server
[source,java]
----
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.config.server.EnableConfigServer;

@EnableConfigServer
@SpringBootApplication
public class ConfigServerApplication {

    public static void main(String[] args) {
        SpringApplication.run(ConfigServerApplication.class, args);
    }

}
----
+
. Restart the `config-server`.
. Restart the `items-service` application.
____

The `items-service` application should now start with config loaded from `config-server`. This can be checked as follows:

* `config-server`: Use `curl http://localhost:8888/items-service/default | jq` to see the stored config for `items-service`. The json object "propertySources" should hold the expected config.
* `items-service`: Use http://localhost:8080/h2-console and see if the console is accessible. It is disabled by default, so if it is present it means that the our config read from server is in effect.

=== Overriding default setup
Up until now we have relied on the automagical means of setting up the `config-server` and having a client app using it. Our client `items-service` uses the default uri https://localhost:8888 to fetch config.

But what if we can't run the server on the default port, or if we want to change how the client acts in other ways? Let's take a look at this by changing the port of the `config-server`.

[quote]
____
. Open `config-server/src/main/resources/bootstrap.yml`.
. Change the `server.port` value to 7777
. Restart the `config-server` and verify it runs on the new port
. Restart the `items-service`. Expect to see a connection error log since the service tries to connect to port 8888.
____

What's all this about using a file _bootstrap.yml_ instead of an _application.yml_? Well bootstrap.yml is used in Spring Cloud for loading properties into a _parent application context_. That _parent application context_ is loaded _before_ the ordinary _Spring application context_, which uses application.yml. This means that properties defined in bootstrap.yml takes precedence over properties defined in application.yml.

application.yml or application.properties::
The `application.yml or application.properties` file is specific to Spring Boot applications. Unless you change the location of external properties of an application, spring boot will always load application.yml from the following location:

----
/src/main/resources/application.yml
----

You can store all the external properties for your application in this file. Common properties that are available in any Spring Boot project can be found at: https://docs.spring.io/spring-boot/docs/current/reference/html/common-application-properties.html You can customize these properties as per your application needs.

bootstrap.yml or bootstrap.properties::
The `bootstrap.yml or bootstrap.properties` file on the other hand is specific to spring-cloud-config and is loaded before the application.yml.
+
Here is the take-away: *bootstrap.yml is only needed if you are using Spring Cloud and your microservice configuration is stored on a remote Spring Cloud Config Server*.
+
[IMPORTANT]
====
When using bootstrap.yml with Spring Cloud Config server, you shall specify the application-name and other cloud.config.server properties, similar to what we already do in `config-server/src/main/resources/bootstrap.yml`

When used with Spring Cloud clients (other than cloud config server), we need to specify the application name and the location of config server (if not using the default http://localhost:8888)
====

The default behavior for any application that has the _Spring Cloud Config Client_ on classpath is as follows: When a config client starts, it binds to the `config-server` (through the `spring.cloud.config.uri` bootstrap configuration property, which defaults to "http://localhost:8888") and then initializes it's own Spring Environment with property sources found on the `config-server`.

When we have changed the `config-server` to use port 7777 instead of the default, we also need to mirror this in the configuration of our clients. All client applications that want to consume content from the `config-sever` also need a `bootstrap.yml` (or an environment variable) where they specify the property `spring.cloud.config.uri=http://localhost:7777`.


[quote]
____
. Delete `items-service/src/main/resources/application.yml`
. Create `items-service/src/main/resources/bootstrap.yml`.
. Add the needed spring application name and also configure the config client to fail fast if it cannot connect to config-server:
+
[source,yml]
----
spring:
  application:
    name: items-service
  cloud:
    config:
      fail-fast: true

server:
  port: 8080
----
+
. Restart the `items-service`. What happens?
. Add the changed uri of the `config-server` into `items-service/src/main/resources/bootstrap.yml`
+
[source,yml]
----
spring:
  application:
    name: items-service
  cloud:
    config:
      uri: http://localhost:7777
      fail-fast: true

server:
  port: 8080
----
. Start the `items-service`.
____

The `items-service` should now load the config from `config-server` located at http://localhost:7777.

This concludes our efforts around the Spring Cloud Config Server for the moment. There is of course more to leverage here, like refreshing and pushing changes in the central config out to running clients. But that is for another occasion. Now it is time to move on to the Reviews service.

<<03-reviews-service.adoc#,Nextup: Review-Service>>

