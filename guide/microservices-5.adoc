= Spring Cloud
:toc: left
:imagesdir: images

ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]

== WebApi
The webapi will be responsible for aggregating data and information from underlying services, and deliver it in a format suitable for the client.

As you recall from the previous section, the webapi is influenced by the Backends for Frontends (BFF) pattern.

.BFF pattern
image::bff.png[]

Translated to our schematic overview, _WebApi_ takes the same role as _Web BFF_ or _Mobile BFF_ do in figure 1 above.

image::overview-5-webapi.png[]

The `webapi` component will provide a set of REST resources for retrieving _items_ and _reviews_ from `items-service` and `reviews-service`. It will make use of the `service-discovery-client` to find where these services are located.

[TIP]
====
What does a BFF typically do?
Can handle api-keys and authentication if desired.
====

=== Creating the project

[quote]
____
. Go to https://start.spring.io/ (or use IntelliJ `New -> Module... -> Spring Initializr`)
. Enter the following values in fields:
.. `Group:` com.acorn.tutorial
.. `Artifact:` webapi
. Add dependencies (search for them and select):
.. Spring Config Client
.. Eureka Discovery Client
.. Spring Web
.. OpenFeign
.. Spring Boot Actuator
.. Lombok
. Click `Generate the project`
. If using https://start.spring.io: open the resulting zip and copy the items-service directory to the root of the project (acorn-microservices-tutorial)
____

[TIP]
====
Let's remove some autogenerated files we don't need, delete the following files from project:

- items-service/.mvn (the whole dir)
- items-service/.gitignore
- items-service/HELP.md
- items-service/mvnw
- items-service/mvnw.cmd
====

Edit the `pom.xml` in a similar fashion as we did for the item-service:
[quote]
____
. Open `acorn-microservices-tutorial/webapi/pom.xml`
. Change the reference to parent pom as follows:
+
Change
+
[source,xml]
----
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.1.8.RELEASE</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    <groupId>com.acorn.tutorial</groupId>
    <artifactId>webapi</artifactId>
    <version>0.0.1-SNAPSHOT</version>

----
to
+
[source,xml]
----
    <parent>
        <artifactId>acorn-microservices-tutorial</artifactId>
        <groupId>com.acorn.tutorial</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>

    <artifactId>webapi</artifactId>
----
+
Note that _groupId_ and _version_ attributes of reviews-service can be removed since this project now inherits these attributes from the parent pom.
+
Also remove the `<properties>..</properties>, <dependencyManagement>..</dependencyManagement>` and `<build>..</build>` completely.
____

Next edit the parent pom.xml so that it becomes aware of the child project:
[quote]
____
. Open `acorn-microservices-tutorial/pom.xml`
. Add `service-discovery-server` to the modules list in the parent pom:
+
[source,xml]
----
    ...

    <modules>
        <module>config-server</module>
        <module>service-discovery-server</module>
        <module>items-service</module>
        <module>reviews-service</module>
        <module>webapi</module>
    </modules>

    ...
----
____

Build the project to verify that all is glued together correctly, and for downloading dependencies:
[source, bash]
----
# Run mvn clean install from the acorn-microservices-tutorial directory
mvn clean install -DskipTests
----

Note that you must run the command with the flag `-DskipTests`, if not an autogenerated Spring test will fail.

Expected outcome after running the command:

[source]
----
[INFO] Reactor Summary:
[INFO]
[INFO] acorn-microservices-tutorial ....................... SUCCESS [  1.513 s]
[INFO] config-server ...................................... SUCCESS [  3.292 s]
[INFO] service-discovery-server ........................... SUCCESS [  2.063 s]
[INFO] items-service ...................................... SUCCESS [  3.377 s]
[INFO] reviews-service .................................... SUCCESS [  4.808 s]
[INFO] webapi ............................................. SUCCESS [  3.980 s]
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
----

=== Configuring the WebApi
The first thing to configure is to hook up the WebApi with the Config Server.

* The application's general config should be defined in the central `config-server`
* A `bootstrap.yml` file must be created, holding the config for binding to the `config-server`

[quote]
____
. Create the file `config-server/src/main/resource/config/webapi.yml`
. Add config to file:
+
[source,yml]
----
eureka:
  client:
    register-with-eureka: true
    service-url:
      default-zone: http://localhost:8761/eureka
----
+
. Rebuild the `config-server`
+
[source,bash]
----
cd config-server
mvn clean install -DskipTests
----
+
. Restart `webapi`
. Verify that all looks good by accessing http://localhost:7777/webapi/default
____

Next create the `bootstrap.yml` and add config for binding to `config-server`
[quote]
____
. Delete `webapi/src/main/resources/application.properties`
. Create the file `webapi/src/main/resource/bootstrap.yml`
. Add config to file:
+
[source,yml]
----
spring:
  application:
    name: webapi
  cloud:
    config:
      uri: http://localhost:7777
      fail-fast: true

feign:
  hystrix:
    enabled: false

server:
  port: 8100
----
____

=== Adding source code
Let's add some initial code that defines the REST API in the form of a `@RestController`. The goal is to have this controller call `items-service` and `reviews-service` and aggregate the information into `ItemInfoDto`, which is sent back in responses.

Start with adding the `ItemInfoDto` class. Noteworthy here is that this class represents an _Item_ with it's associated _Reviews_.

[quote]
____
. Create a new package `webapi/src/main/java/com/acorn/tutorial/webapi/web`
. Add a file named `ItemInfoDto.java` with the below content:
+
[source,java]
----
@Data
@ToString
public class ItemInfoDto {

    private Item item;
    private List<Review> reviews;

    public static ItemInfoDto of(Item item, List<Review> reviews) {
        return new ItemInfoDto(item, reviews);
    }

    private ItemInfoDto(Item item, List<Review> reviews) {
        this.item = item;
        this.reviews = reviews;
    }
}
----
+
. Make it compile by adding `Item.java` and `Review.java` as well. These two classes will later be used for mapping responses from `items-service` and `reviews-service`
.. `webapi/src/main/java/com/acorn/tutorial/webapi/web/Item.java`
+
[source,java]
----
@Data
@ToString
@AllArgsConstructor
public class Item {

    private Long id;

    private String name;

    private int port;
}
----
.. `webapi/src/main/java/com/acorn/tutorial/webapi/web/Review.java`
+
[source,java]
----
@Data
@AllArgsConstructor
@ToString
public class Review {

    private Long id;

    private String type;

    private Long typeId;

    private Integer rating;

    private Integer ratingMin;

    private Integer ratingMax;

    private String comment;

    private int port;
}
----
____

Now we can concentrate on the actual REST endpoints, by adding a class `WebApiController.java` annotated with `@RestController`.

[quote]
____
. Add `webapi/src/main/java/com/acorn/tutorial/webapi/web/WebApiController.java`. In the beginning this will only contain skeleton code, just returning empty objects.
+
[source,java]
----
@RestController
public class WebApiController {

    private static final Logger LOGGER = LoggerFactory.getLogger(WebApiController.class);

    @GetMapping(path = "/webapi/items")
    public List<ItemInfoDto > getItems() {
        return Collections.singletonList(ItemInfoDto.of(null, null));
    }

    @GetMapping(path = "/webapi/items/{id}")
    public ItemInfoDto getItem(@PathVariable Long id) {

        return ItemInfoDto.of(null, null);
    }
}
----
____

So far we haven't encountered anything new here, we have added REST-controllers before in `items-service` and `reviews-service`. This is yet another REST-interface. But it is starting to get interesting now since a new question springs to mind:

How do we call the underlying services in the most easiest way?



==== OpenFeign

=== Running the application
You should be able to start the server by using one of these two options.

Run from IDE::
IntelliJ: There should be a Run configuration named `WebApiApplication` in the Services pane. Mark it and press the green play-button to start the application. This will build and run the app.
+
Eclipse: TODO

Run from command line:: It is also possible to execute it directly from a command prompt:
+
[source, bash]
----
cd acorn-microservices-tutorial/webapi/target

java -jar webapi-1.0-SNAPSHOT.jar
----


<<microservices-6.adoc#,Nextup: Client load balancer>>

