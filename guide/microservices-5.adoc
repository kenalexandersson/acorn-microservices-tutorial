= Spring Cloud
:toc: left
:imagesdir: images

ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]

== WebApi
 `items-service` and `reviews-service`

image::overview-5-webapi.png[]

=== Creating the project

[quote]
____
. Go to https://start.spring.io/ (or use IntelliJ `New -> Module... -> Spring Initializr`)
. Enter the following values in fields:
.. `Group:` com.acorn.tutorial
.. `Artifact:` service-discovery-server
. Add dependencies (search for them and select):
.. Eureka Server
.. Spring Config Client
.. Spring Boot Actuator
. Click `Generate the project`
. If using https://start.spring.io: open the resulting zip and copy the items-service directory to the root of the project (acorn-microservices-tutorial)
____

[TIP]
====
Let's remove some autogenerated files we don't need, delete the following files from project:

- items-service/.mvn (the whole dir)
- items-service/.gitignore
- items-service/HELP.md
- items-service/mvnw
- items-service/mvnw.cmd
====

Edit the `pom.xml` in a similar fashion as we did for the item-service:
[quote]
____
. Open `acorn-microservices-tutorial/webapi/pom.xml`
. Change the reference to parent pom as follows:
+
Change
+
[source,xml]
----
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.1.8.RELEASE</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    <groupId>com.acorn.tutorial</groupId>
    <artifactId>service-discovery-server</artifactId>
    <version>0.0.1-SNAPSHOT</version>

----
to
+
[source,xml]
----
    <parent>
        <artifactId>acorn-microservices-tutorial</artifactId>
        <groupId>com.acorn.tutorial</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>

    <artifactId>service-discovery-server</artifactId>
----
+
Note that _groupId_ and _version_ attributes of reviews-service can be removed since this project now inherits these attributes from the parent pom.
+
Also remove the `<properties>..</properties>, <dependencyManagement>..</dependencyManagement>` and `<build>..</build>` completely.
____

Next edit the parent pom.xml so that it becomes aware of the child project:
[quote]
____
. Open `acorn-microservices-tutorial/pom.xml`
. Add `service-discovery-server` to the modules list in the parent pom:
+
[source,xml]
----
    ...

    <modules>
        <module>config-server</module>
        <module>service-discovery-server</module>
        <module>items-service</module>
        <module>reviews-service</module>
    </modules>

    ...
----
____

Build the project to verify that all is glued together correctly, and for downloading dependencies:
[source, bash]
----
# Run mvn clean install from the acorn-microservices-tutorial directory
mvn clean install -DskipTests
----

Note that you must run the command with the flag `-DskipTests`, if not an autogenerated Spring test will fail.

Expected outcome after running the command:

[source]
----
[INFO] Reactor Summary:
[INFO]
[INFO] acorn-microservices-tutorial ....................... SUCCESS [  6.626 s]
[INFO] config-server ...................................... SUCCESS [ 13.495 s]
[INFO] service-discovery-server ........................... SUCCESS [  1.111 s]
[INFO] items-service ...................................... SUCCESS [  4.785 s]
[INFO] reviews-service .................................... SUCCESS [  1.945 s]
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
----

=== Configuring the WebApi
The first thing to configure is to hook up the Service Discovery Server with the Config Server.

* The application's general config should be defined in the central `config-server`
* A `bootstrap.yml` file must be created, holding the config for binding to the `config-server`

[quote]
____
. Create the file `config-server/src/main/resource/config/webapi.yml`
. Add config to file:
+
[source,yml]
----

----
+
. Rebuild the `config-server`
+
[source,bash]
----
cd config-server
mvn clean install -DskipTests
----
+
. Restart `webapi`
. Verify that all looks good by accessing http://localhost:7777/webapi/default
____

Next create the `bootstrap.yml` and add config for binding to `config-server`
[quote]
____
. Delete `webapi/src/main/resources/application.properties`
. Create the file `webapi/src/main/resource/bootstrap.yml`
. Add config to file:
+
[source,yml]
----
spring:
  application:
    name: webapi
  cloud:
    config:
      uri: http://localhost:7777
      fail-fast: true
----
____

=== Adding source code

=== Running the application
You should be able to start the server by using one of these two options.

Run from IDE::
IntelliJ: There should be a Run configuration named `WebApiApplication` in the Services pane. Mark it and press the green play-button to start the application. This will build and run the app.
+
Eclipse: TODO

Run from command line:: It is also possible to execute it directly from a command prompt:
+
[source, bash]
----
cd acorn-microservices-tutorial/webapi/target

java -jar webapi-1.0-SNAPSHOT.jar
----


<<microservices-6.adoc#,Nextup: Client load balancer>>

